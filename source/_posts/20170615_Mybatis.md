---
title: Mybatis入门学习

comments: true    

tags: 
    - Mybatis

categories: 
    - 框架相关

description: 

date: 2017-02-28
   
---
## 什么是 MyBatis ？
> 官方文档: http://www.mybatis.org/mybatis-3/zh/index.html

> MyBatis 一个基于Java的持久层框架; 是支持定制化 SQL、存储过程以及高级映射的优秀的持久层框架。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以对配置和原生Map使用简单的 XML 或注解，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。

###### *与hibernate不同的是: mybatis是通过xml映射文件实现接口来实现操作数据库的功能*

<!--more-->

### 基本的步骤:
#### 1. 引入dependency
```aidl
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.1</version>
        </dependency>
```


#### 2. mybatis核心配置文件 #在resources目录下的 mybatis/conf.xml

```aidl
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
    <configuration>
        <!--可以读取数据库配置文件 用EL表达式获取参数-->
        <!--<properties resource="classpath:mybatis/db.properties"/>-->
    
        <!--
            development : 开发模式
            work : 工作模式
         -->
        <environments default="development">
            <environment id="development">
                <transactionManager type="JDBC"/>
                <dataSource type="POOLED">
                    <property name="driver" value="com.mysql.jdbc.Driver"/>
                    <property name="url"
                              value="jdbc:mysql://localhost:3306/test?zeroDateTimeBehavior=convertToNull&amp;useUnicode=true&amp;characterEncoding=UTF-8"/>
                    <property name="username" value="root"/>
                    <property name="password" value="fangshuoit"/>
                </dataSource>
            </environment>
        </environments>
    
        <!--映射文件所在位置 可以使用通配符 -->
        <mappers>
            <mapper resource="com/mybatis/test1/pojo/MyUserMapper.xml"/>
        </mappers>
    </configuration>
```
*如果需要(或者测试没日志)可以引入log4j的包和配置文件 方便测试*

#### 3. 新建实体类--MyUser.java 对应数据库中表my_user 
```aidl
        //三个属性
        private int id;
        private String name;
        private int age;

```

#### 4. 新建Mapper映射文件--MyUserMapper.xml(要和实体放到一个目录下)
```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.mybatis.test1.pojo.MyUserMapper">
        <!--
            根据id查询得到一个user对象
         -->
        <select id="getUser" parameterType="int" resultType="com.mybatis.test1.pojo.MyUser">
            SELECT *
            FROM my_user
            WHERE id = #{id}
        </select>
    </mapper>
```

*maven项目运行时找不到映射文件:Could not find resource;(原因是maven在构建的时候不会识别src下的配置文件,见生成的class目录)所以有两种方法解决*
```aidl
    1.在resources下新建目录,目录结构和java下的一致(因为需要保证映射文件和实体在同一个目录下),到时候生成的.class就会和配置文件放到一起,就可以找到了
    2.(推荐), 添加设置资源目录: 在pom的build下加入:
                <resources>
                    <resource>
                        <directory>src/main/java</directory>
                        <includes>
                            <include>**/*.xml</include>
                        </includes>
                        <filtering>false</filtering>
                    </resource>
                </resources>
```

#### 5.可以测试啦: 添加测试类--MainTest.java

```aidl
        private SqlSession util(){
            //配置文件
            String resource = "mybatis/conf.xml";
    
            //加载配置mybatis文件
            InputStream input = MainTest.class.getClassLoader().getResourceAsStream(resource);
    //      Reader reader = Resources.getResourceAsReader(resource); //也可以使用这个加载配置
            //构建sqlSession工厂
            SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(input);
            //得到能执行映射文件中sql语句的sqlSession(等同于jdbc中的PreparedStatement)
            SqlSession session = sqlSessionFactory.openSession(true);//设置自动提交事务
    
            return session;
        }
    
        @Test
        public void testSelect() {
            SqlSession session = util();
            //映射sql的标识符字符串(映射文件全类名 + 映射节点id)
            String statement = "com.mybatis.test1.pojo.MyUserMapper.getUser";
            //执行sql语句返回结果
            MyUser user = session.selectOne(statement, 12);//两个参数 statement和占位符要填写的参数
    
            System.out.println(user);
        }
```

#### 6. 大功告成 ! 

#### 7. 其他操作 : CURD

> 增删改查实现方法, 1. 增加映射文件内容; 

```aidl
    <!--
            插入一个用户
        -->
        <insert id="addUser" parameterType="com.mybatis.test1.pojo.MyUser">
            INSERT INTO my_user (id, name, age) VALUES (#{id}, #{name}, #{age})
        </insert>
    
        <!--
            根据id删除一个用户
        -->
        <delete id="delUser" parameterType="int">
            DELETE FROM my_user
            WHERE id = #{id}
        </delete>
    
        <!--
            更新用户信息
        -->
        <update id="editUser" parameterType="com.mybatis.test1.pojo.MyUser">
            UPDATE my_user
            SET name = #{name}, age = #{age}
            WHERE id = #{id}
        </update>
    
        <!--
            根据id查询得到一个user对象
         -->
        <select id="getUser" parameterType="int" resultType="com.mybatis.test1.pojo.MyUser">
            SELECT *
            FROM my_user
            WHERE id = #{id}
        </select>
    
        <select id="getAllUser" resultType="com.mybatis.test1.pojo.MyUser">
            SELECT *
            FROM my_user
        </select>

```

> 2.调用sqlSession的各种方法(方法名基本上是个人都能看出来干嘛的,你就直接试); 比如

```aidl
    int result = session.delete(statement, 1);
    
    List<MyUser> users = session.selectList(statement);
    
    ....
```

#### 8. 基于接口的写法: 
> 基于接口有两种具体实现 1.基于注解:不需要自己写实现类,实现类自己"生成"; 2:基于xml文件,需要把xml文件和接口放在同一个目录下

#####  基于注解
1.新建一个接口--MyUserMapper.java
```aidl
    public interface MyUserMapper {
    
        @Insert("INSERT INTO my_user (id, name, age) VALUES (#{id}, #{name}, #{age})")
        public int add(MyUser user);
    
        @Delete("DELETE FROM my_user WHERE id = #{id}")
        public int del(int id);
    
        @Update("UPDATE my_user SET name = #{name}, age = #{age} WHERE id = #{id}")
        public int edit(MyUser user);
    
        @Select("SELECT * FROM my_user WHERE id = #{id}")
        public MyUser find(int id);
    
        @Select("SELECT * FROM my_user")
        public List<MyUser> getAll();
    }

```
2."注册"到mybatis配置文件--在conf.xml中mappers节点下添加
```aidl
    <mapper class="com.mybatis.test2.pojo.MyUserMapper"/>
```

3.测试
```aidl
    String resource = "mybatis/conf.xml";
    InputStream input = MainTest.class.getClassLoader().getResourceAsStream(resource);
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(input);
    SqlSession session = sqlSessionFactory.openSession(true);
    //获取接口动态产生的实现类 再调用方法
    MyUserMapper myUserMapper = session.getMapper(MyUserMapper.class);
    MyUser user = myUserMapper.find(12);

    System.out.println(user);
    
```

#####  基于配置文件
1.接口和实现xml文件--MyUserMapper.java & MyUserMapper.xml
```aidl
    public interface MyUserMapper {
    
        //方法要求 类名必须与.xml名相同; 方法名必须与MyUserMapper.xml中对应的id相同; 并且参数要一一对应
        public List<MyUser> getAll();
    }

    <select id="getAllUser" resultType="com.mybatis.test2.pojo.MyUser">
        SELECT *
        FROM my_user
    </select>
```
2."注册"到mybatis配置文件--在conf.xml中mappers节点下添加(二选一, 只要有一个就可定位Mapper)
```aidl
    <mapper class="com.mybatis.test2.pojo.MyUserMapper"/>
    
    <mapper resource="com/mybatis/test2/pojo/MyUserMapper.xml"/>
```

3.测试(方法不变 只需改方法)

#### 9.优化
> 1.数据库文件: 把数据库信息配置到一个文件: db.properties,然后在conf.xml中引入,调用使用EL表达式
```aidl
    <properties resource="classpath:mybatis/db.properties"/>

```

> 2.配置别名: 在映射文件中写全类名很长很麻烦,可以在conf.xml中配置别名 alias为别名; 则可以在映射xml文件中写别名表示此类
```aidl
   <typeAliases>
       <typeAlias type="com.mybatis.test2.pojo.MyUser" alias="_MyUser"/>
   </typeAliases>
``` 

> 2.配置别名2: 为整个包下类取别名 则别名为此类类名(比如: MyUser)
```aidl
   <typeAliases>
       <package name="com.mybatis.test2.pojo"/>
   </typeAliases>
``` 

#### n.分页插件(ing...)