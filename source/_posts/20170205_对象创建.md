---
title: 3.HotSpot虚拟机 对象创建

comments: true    

tags: 
    - 深入了解java虚拟机
    - java

categories: 
    - java虚拟机

description:

date: 2017-02-05 #文章生成時間
   
---

## **对象创建**

 1. new指令 （new一个对象）
 2. 检查这个指令的参数是否能在常量池中定位到一个类符号引用
 3. 检查此符号引用代表的类是否被加载，解析，初始化过
 4. 否：执行相应的类加载
 5. 是（类被加载过后），虚拟机为新生的对象分配内存（大小在类加载时确定），把某大小的堆内存划分给此对象
    
    5.1. 如果堆内存整齐划分：分配内存实质是把指向空闲内存的指针移动该对象大小相等的位置，这种分配方式叫**指针碰壁**
    
    5.2 如果堆内存空闲内存与非空闲随机：则虚拟机会维护一个内存列表，每次分配都划分相应的内存给对象，这种分配方式叫**空闲列表**
    
 6. 分配方式决定于Java堆是否规整，Java堆是否规整决定于采用的垃圾回收器是否有压缩整理功能。
    
    6.1 并发情况下，对于修改指针指向位置，有两种方案
              
        1.对分配内存空间进行同步处理--实际上，虚拟机采用CAS配上失败重试的方法保证更新操作的原子性
        2.把内存的分配的动作按照线程划分在不同的空间进行，即每个线程在Java堆中预先分配一小块内存（称为本地线程分配缓冲TLAB），哪个线程需要分配内存，就在哪个线程的TLAB上分配，当TLAB用完需要分配新的TLAB时才同步锁定 ----- 可以通过-XX:+/-UseTLAB参数设定
 7. 内存分配完毕，虚拟机把分配的内存初始化为零值（不包括对象头），使用TLAB则此可以在TLAB前执行。此步骤保证了对象的实例字段在代码中不赋初值即可使用，程序可访问到这些字段的数据类型所对应的默认初始值
 8. 虚拟机对对象进行必要的设置（指明类，找到类的元数据信息，对象的哈希码等）这些存放在对象的对象头（Object Header）中。 
 9. **对于虚拟机，新的对象已经产生。对于程序，才刚刚开始**
 10. 执行< init >方法，把对象按照程序员意愿进行初始化。可以用的对象新建成功
